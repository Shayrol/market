import {
  ApolloClient,
  ApolloLink,
  ApolloProvider,
  InMemoryCache,
} from "@apollo/client";
import { createUploadLink } from "apollo-upload-client";

interface IApolloSetting {
  children: JSX.Element;
}
const GLOBAL_STATE = new InMemoryCache();

export default function ApolloSetting(props: IApolloSetting): JSX.Element {
  const uploadLink = createUploadLink({
    uri: "https://backend-practice.codebootcamp.co.kr/graphql",
  });
  const client = new ApolloClient({
    link: ApolloLink.from([uploadLink]),

    cache: GLOBAL_STATE,
  });
  console.log("ApolloSetting ì‹¤í–‰ë¨");

  return <ApolloProvider client={client}>{props.children}</ApolloProvider>;
}


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

import {
  ApolloClient,
  ApolloLink,
  ApolloProvider,
  InMemoryCache,
  fromPromise,
} from "@apollo/client";
import { createUploadLink } from "apollo-upload-client";
import { useRecoilState, useRecoilValueLoadable } from "recoil";
import {
  isAccessToken,
  restoreAccessTokenLoadable,
} from "../../../commons/stores";

import { onError } from "@apollo/client/link/error";
import {} from "graphql-request";
import { getAccessToken } from "../../../commons/libraries/getAccessToken";
import { useEffect } from "react";

// {props.children} ì˜ íƒ€ì…ì„ ë§í•¨
interface IApolloSetting {
  children: JSX.Element;
}
// router.pushë¡œ ë¦¬ë Œë”ë§ì´ ì¼ì–´ë‚˜ë„ createUploadLinkì—ì„œ API ìš”ì²­ ì•ˆí•¨ - ApolloSetting í•¨ìˆ˜ ë°–ì— ë³€ìˆ˜ ì„ ì–¸
const GLOBAL_STATE = new InMemoryCache();

export default function ApolloSetting(props: IApolloSetting): JSX.Element {
  // accessToken ì „ì—­ë³€ìˆ˜ì— ì €ì¥í•  ê³µê°„
  const [accessToken, setAccessToken] = useRecoilState(isAccessToken);
  const restoreAccessToken = useRecoilValueLoadable(restoreAccessTokenLoadable);

  useEffect(() => {
    void restoreAccessToken.toPromise().then((newAccessToken) => {
      setAccessToken(newAccessToken ?? "");
    });
  }, []);

  // graphql ë§í¬ ì—°ê²°
  const uploadLink = createUploadLink({
    uri: "https://backend-practice.codebootcamp.co.kr/graphql",
    // í† í°ì„ API ìš”ì²­í•  ë•Œë§ˆë‹¤ bodyê°€ ì•„ë‹Œ headerì— ë‹´ì•„ ìš”ì²­
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
    // ì¿ í‚¤ í—¤ë”ì— ì €ì¥ë˜ì–´ìˆëŠ” í† í°ì„ í¬í•¨í•´ì„œ API ìš”ì²­
    // ë³´ì•ˆìƒ ë¡œì»¬,ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ì„ í•˜ì§€ ì•ŠìŒ
    // ì•„ë˜ ì„¤ëª…í™•ì¸
    credentials: "include",
  });

  // accessToken ì—ëŸ¬ - uploadLink ì•ì— linkê°€ ë“¤ì–´ê°€ì•¼í•¨
  // 1. graphQLErrors = ì—ëŸ¬ê°€ ì¡íˆë©´ ë“¤ì–´ì˜¤ëŠ” ê³³
  //    - unauthenticatedê°€ ìˆëŠ”ì§€ í™•ì¸(ì—†ì–´ì•¼ í•¨)
  //    - í•´ë‹¹ graphQLErrorsì˜ ë°°ì—´ì˜ ê° ìš”ì†Œì˜ íƒ€ì…ì€ undefinedì—¬ì•¼ ì—ëŸ¬ê°€ ì—†ë‹¤ëŠ” ëœ»
  // 2. operation = ì‹¤íŒ¨í•œ queryê°€ ë“¤ì–´ì˜¤ëŠ” ê³³
  // 3. forward = ì‹¤íŒ¨í–ˆë˜ê±¸ ìˆ˜ì •ì„ í†µí•´ ì¬ìš”ì²­ í•˜ëŠ” ê³³
  const errorLink = onError(({ graphQLErrors, operation, forward }) => {
    // 1. ì—ëŸ¬ë¥¼ ìºì¹˜
    if (typeof graphQLErrors !== "undefined") {
      // forë¬¸ì„ í†µí•´ graphQLErrorsì˜ ì—ëŸ¬ë¥¼ errì— ë‹´ëŠ”ë‹¤.
      for (const err of graphQLErrors) {
        // ì—ëŸ¬ì½”ë“œê°€ UNAUTHENTICATEDë©´ í† í°ë§Œë£Œë¼ëŠ” ëœ»
        if (err.extensions.code === "UNAUTHENTICATED") {
          // 2. refreshTokenìœ¼ë¡œ accessTokenì„ ì¬ë°œê¸‰ ë°›ê¸°
          // useë¡œ ì‹œì‘í•˜ëŠ” useMutationì€ ì‚¬ìš©ì„ í•  ìˆ˜ ì—†ë‹¤.
          // clientì—ì„œ ì„¸íŒ…ì´ ì „ë‹¬ì´ ëœ ì´í›„ì— ì¦‰ {props.children}ì—ì„œë§Œ ì‚¬ìš©ì´ ê°€ëŠ¥í•¨
          // ê·¸ë˜ì„œ ì•„ì§ errorLinkëŠ” ì…‹íŒ… ì¤‘ì´ë‹¤.
          // useì—†ì´ refreshToken API ìš”ì²­ì„ ë³´ë‚´ì•¼ í•˜ëŠ”ë° npmì— graphql-requestê°€ ìˆë‹¤.
          // yarn add graphql-request graphql
          // ì˜ˆì œì—ì„œëŠ” React/class/src/commons/libraries/getAccessToken.tsì— ë¶„ë¦¬í•¨
          // ì¬ì‚¬ìš©ì„± ë§ìŒ!
          return fromPromise(
            // getAccessToken()í•¨ìˆ˜ê°€ ì„±ê³µí•˜ë©´ ë°˜í™˜ê°’ì„ .then((newAccessToken))ì— ë‹´ì•„
            // setAccessTokenì— ìˆ˜ì •ì„ í•œë‹¤.
            getAccessToken().then((newAccessToken) => {
              setAccessToken(newAccessToken ?? "");
              // getContext: ê°€ì ¸ì˜¤ëŠ” ê²ƒ
              // setContext: ìˆ˜ì •í•˜ëŠ” ê²ƒ
              operation.setContext({
                headers: {
                  // ê¸°ì¡´ í—¤ë”ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜¨ë‹¤.
                  ...operation.getContext().headers,
                  // ë§Œë£Œëœ í† í°ì„ newAccessTokenìœ¼ë¡œ ìƒˆë¡œìš´ í† í°ìœ¼ë¡œ ë³€ê²½
                  Authorization: `Bearer ${newAccessToken}`,
                },
              });
            })
            // 3. ì¬ë°œê¸‰ ë°›ì€ accessTokenìœ¼ë¡œ ë°©ê¸ˆ ì‹¤íŒ¨í•œ ì¿¼ë¦¬ ì¬ìš”ì²­í•˜ê¸°
            // ìˆ˜ì •ì„ operation.setContext í†µí•´ headersë¥¼ ìˆ˜ì •í•œ ë‚´ìš©ì„
            // ì¿¼ë¦¬ ì¬ìš”ì²­í•˜ê¸°
            // flatMap() :ì´ëŸ¬í•œ ë‚´ìš©ì„ ë§¤ë²ˆ ì¬ ì‹¤í–‰í•˜ê¸° ìœ„í•¨
            // forward : ì¿¼ë¦¬ë¬¸ì„ ì¬ìš”ì²­í•˜ê¸° ìœ„í•¨
            // ì¦‰ flatMapì„ í†µí•´ ë§¤ë²ˆ forwardì˜ ì¿¼ë¦¬ë¬¸ì„ ì¬ìš”ì²­
          ).flatMap(() => forward(operation));
        }
      }
    }
  });

  const client = new ApolloClient({
    link: ApolloLink.from([errorLink, uploadLink]),

    // ìºì‹œí•˜ê³  ê°™ì€ ë°ì´í„° ìš”ì²­ì‹œ ìµœì‹  ë°ì´í„° ìš”ì²­í•˜ì§€ ì•Šê³  ì‚¬ìš©
    cache: GLOBAL_STATE,
  });
  console.log("ApolloSetting ì‹¤í–‰ë¨");

  // prettier-ignore
  return (
    <ApolloProvider client={client}>
      {props.children}
    </ApolloProvider>
  )
}

// ğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆğŸˆ
// ì¿ í‚¤ì˜ credentials: "include" ì„¤ëª…:
// 1. uploadLink, getAccessToken()ì— credentials: "include"ê°€ ì‚¬ìš©ì´ ëëŠ”ë°
// 2. ê²°ë¡ ì„ ë¨¼ì € ì„¤ëª…ì„ í•˜ìë©´ í•´ë‹¹ ê¸°ëŠ¥ì€ ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€, refreshTokenì„ í•˜ëŠ”ë° í•„ìš”í•˜ë‹¤.
// 3. uploadLinkì— ì‚¬ìš©ëœ credentials: "include"ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
//   - í•´ë‹¹ urlë¡œ accessTokenì„ ë‹´ì•„ ìš”ì²­ì„ í•˜ëŠ”ë° ì§€ì†ì ì¸ ë¡œê·¸ì¸ ìœ ì§€ê°€ í•„ìš”í•  ë•Œ
//   - ì¦‰ í˜ì´ì§€ ì´ë™, ìƒˆë¡œê³ ì¹¨ ë“±ìœ¼ë¡œ ë§¤ë²ˆ ë¡œê·¸ì¸ì„ í•  í•„ìš”ê°€ ì—†ì–´ì§„ë‹¤.
// 4. getAccessToken()ì—ë„ ì‚¬ìš©ì´ ë˜ëŠ”ë° ë‹¤ìŒê³¼ ê°™ë‹¤.
//   - graphqlì—ì„œì˜ restoreTokenì´ë¼ëŠ” API ìš”ì²­ì—ëŠ” ì¿ í‚¤ì˜ credentials: "include"ê°€
//   - ìˆì–´ì•¼ restoreTokenì˜ API ìš”ì²­ì„ í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤.
//   - ì¦‰ accessToken ì¬ë°œê¸‰ì´ í•„ìš”í•œ ê²½ìš° ì¿ í‚¤ì˜ refreshTokenì„ ì‚¬ìš©í•´ì•¼í•˜ëŠ”ë° ì´ëŠ”
//   - credentials: "include"ë¥¼ ì‚¬ìš©ì„ í•´ì•¼í•œë‹¤.
// 5. ë”°ë¼ì„œ ì¿ í‚¤ì˜ credentials: "include"ì˜ ê¸°ëŠ¥ì€
//   5-1
//    - ë¡œê·¸ì¸ì„ í•˜ë©´ accessTokenì´ ë°œê¸‰ì´ ë˜ëŠ”ë° í•´ë‹¹ í† í°ë§Œë£Œ, ì‚¬ë¼ì§ìœ¼ë¡œ
//    -    ë§¤ë²ˆ ë¡œê·¸ì¸ì„ í•´ì¤˜ì•¼í•˜ëŠ” ë¶ˆí¸í•¨ì„ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
//   5-2
//    - í† í°ë§Œë£Œ, ì‚¬ë¼ì§ìœ¼ë¡œ í•´ë‹¹ í† í°ì„ ì¬ë°œê¸‰ ë°›ì•„ì•¼ í•˜ëŠ”ë° í•´ë‹¹ restoreTokenì˜ API ì‚¬ìš©
//    - í•˜ê¸° ìœ„í•´ì„œëŠ” ì¿ í‚¤ì˜ refreshTokenì´ í•„ìš”í•˜ë‹¤ ê·¸ëŸ¬ê¸° ìœ„í•´ì„œ credentials: "include"ë¥¼
//    - ì‚¬ìš©í•œ ì´ìœ ì´ë‹¤.
//
// ChatGPTë‹˜ ë‹µë³€ ã…ã…
// 1. uploadLinkì—ì„œ credentials: "include" ì‚¬ìš©:
//   - uploadLinkì—ì„œ credentials: "include"ë¥¼ ì‚¬ìš©í•˜ë©´,
//   - ìš”ì²­ì— ì¿ í‚¤ê°€ í¬í•¨ë˜ì–´ ì„œë²„ì— ì „ì†¡ë©ë‹ˆë‹¤.
//   - ì´ëŠ” ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³ , í˜ì´ì§€ ì´ë™ì´ë‚˜ ìƒˆë¡œê³ ì¹¨ ë“±ìœ¼ë¡œ ì¸í•´
//   - ë§¤ë²ˆ ë¡œê·¸ì¸ì„ ë‹¤ì‹œ í•˜ì§€ ì•Šì•„ë„ ë˜ë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.
//
// 2. getAccessToken()ì—ì„œ credentials: "include" ì‚¬ìš©:
//   - getAccessToken() í•¨ìˆ˜ì—ì„œë„ ë§ˆì°¬ê°€ì§€ë¡œ credentials: "include"ë¥¼ ì‚¬ìš©í•˜ì—¬
//   - GraphQL APIë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. ì´ëŠ” restoreToken APIì™€ ê°™ì´,
//   - accessTokenì„ ì¬ë°œê¸‰ ë°›ì•„ì•¼ í•  ê²½ìš° ì¿ í‚¤ì— ì €ì¥ëœ refreshTokenì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•´ì¤€ë‹¤.
//
// 3. ì¿ í‚¤ì˜ credentials: "include"ì˜ ê¸°ëŠ¥:
//   - ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€: ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ìƒíƒœì—ì„œ í˜ì´ì§€ë¥¼ ì´ë™í•˜ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨ì„ í•´ë„
//   - ë§¤ë²ˆ ë¡œê·¸ì¸ì„ ë‹¤ì‹œ í•  í•„ìš”ê°€ ì—†ë„ë¡ í•©ë‹ˆë‹¤.
//
//   - accessToken ì¬ë°œê¸‰: accessTokenì´ ë§Œë£Œë˜ë©´ refreshTokenì„ ì‚¬ìš©í•˜ì—¬
//   - ìƒˆë¡œìš´ accessTokenì„ ì–»ì„ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
//   - ì´ë¥¼ í†µí•´ ì‚¬ìš©ìëŠ” ìë™ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

// ğŸˆ2024.06.15.í†  /
// restoreTokenì„ graphql-requestë¥¼ í†µí•´ ë¹„ë™ê¸°ë¡œ ì¬ë°œê¸‰ë°›ë„ë¡ í–ˆìŒ
// ì´ëŠ” clientê°€ ìƒì„±ë˜ê¸° ì „ useë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•´ useMutationì„ í†µí•´
// restoreToken API ìš”ì²­ì„ ëª»í–ˆìŒ

// í•´ì•¼í•  ê²ƒ:
// 1. accessTokenì„ ë°›ëŠ” API ì¦‰ ë¡œê·¸ì¸ êµ¬í˜„
// 2. íšŒì›ê°€ì…ìœ¼ë¡œ ì´ë©”ì¼/ë¹„ë²ˆ ìƒì„± êµ¬í˜„
// 3. ë¡œê·¸ì¸ìœ¼ë¡œë§Œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” í˜ì´ì§€ êµ¬í˜„
//
//
// ğŸˆ2024.06.17.ì›” /
// í•´ì•¼í•  ê²ƒ:
// 1. accessTokenì„ ë°›ëŠ” API ì¦‰ ë¡œê·¸ì¸ êµ¬í˜„
// 2. íšŒì›ê°€ì…ìœ¼ë¡œ ì´ë©”ì¼/ë¹„ë²ˆ ìƒì„± êµ¬í˜„
// 3. ë¡œê·¸ì¸ìœ¼ë¡œë§Œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” í˜ì´ì§€ êµ¬í˜„
